<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>תרשים גאנט — גרסה 5 (קווים מקווקווים + צבע לפי נושא + Zoom/Week/Export)</title>
<style>
:root{ --labelW:720px; --pxDay:26px; --rowH:52px; --headerH:84px;}
*{box-sizing:border-box;}
body{font-family: DejaVu Sans, 'Noto Sans Hebrew', Arial; margin:16px; color:#111;}

.toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 12px;}
.toolbar button{padding:6px 10px; border:1px solid #ccc; border-radius:10px; background:#fff; cursor:pointer;}
.toolbar button:hover{background:#f3f3f3;}

.controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px;}
.chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #ccc; border-radius:14px; background:#f7f7f7; cursor:pointer;}
.chip input{accent-color:#4aa3ff;}
.chip.active{background:#e0f2ff; border-color:#4aa3ff;}

.gantt{display:flex; align-items:flex-start; border:1px solid #ddd; border-radius:12px; overflow:hidden; position:relative;}
.label-col{flex:0 0 var(--labelW); background:#fff; border-inline-end:1px solid #eee; padding-top:var(--headerH);}
.date-col{position:relative; flex:1 1 auto; overflow-x:auto;}
.timeline{position:relative; padding-bottom:24px;}
.rows{margin:0; padding-top:0;} /* חשוב: לא להוסיף padding-top כאן כדי לא לשבור יישור */
.row{position:relative; height:var(--rowH); border-bottom:1px solid #f5f5f5; margin:0; padding:0 10px;}
.row-bg{position:absolute; left:0; right:0; top:0; bottom:0; background:#fafafa;}
.label{position:absolute; right:12px; left:12px; top:10px; height:26px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:right;}

.scale-wrap{position:sticky; top:0; z-index:10;}
.month-band{height:24px; background:#f7faff; border-bottom:1px solid #e0ecff; display:flex; align-items:center; font-weight:bold; color:#264b9b; padding-inline:8px;}
.week-band{height:22px; background:#fbfbfb; border-bottom:1px solid #eee; display:flex; align-items:center; color:#333;}

/* RTL timeline: keep earliest dates near the label boundary (right edge) */
.date-col .month-band, .date-col .week-band{ flex-direction:row-reverse; }

.week-cell{height:22px; display:flex; align-items:center; justify-content:center; border-right:1px solid #f0f0f0; font-size:12px;}
.day-scale{height:38px; background:#fff; border-bottom:1px solid #eee; position:relative;}
.grid{position:absolute; top:0; left:0; right:0; height:100%;}
.grid div{position:absolute; top:0; bottom:0; border-right:1px dashed #f0f0f0;}
.day{position:absolute; top:20px; text-align:center; color:#333;}
.day .txt{display:inline-block; font-size:10px; transform:rotate(-35deg); transform-origin:50% 0; line-height:1;}

/* ===== Topic colors (single source of truth) ===== */
.topic-block{ --tc:#333; } /* fallback */
.topic-block[data-topic='מר"ס – ממשק']{ --tc:#2ca02c; }
.topic-block[data-topic='מסירות']{ --tc:#9467bd; }
.topic-block[data-topic='Osprey-H Raven']{ --tc:#1f77b4; }
.topic-block[data-topic='אבלואציה  והטמעות']{ --tc:#d62728; }
.topic-block[data-topic='אנטגרציית תחנת Heavy']{ --tc:#ff7f0e; }
.topic-block[data-topic='שיפורי מערכת']{ --tc:#17becf; }

/* ===== Overlay SVG for links from label to pin ===== */
.link-layer{
  position:absolute;
  inset:0;
  z-index:2;
  pointer-events:none;
}

/* Markers */
.connector{
  position:absolute;
  top:calc(var(--rowH)/2);
  height:0;
  border-bottom:1px dashed var(--tc);
  opacity:0.35;
  z-index:3;
}
.pin{
  position:absolute;
  top:calc(var(--rowH)/2 - 8px);
  width:10px;
  height:10px;
  border-radius:50%;
  background: var(--tc);
  border:1px solid var(--tc);
  box-shadow:0 0 0 2px #fff;
  z-index:4;
}
.range-line{
  position:absolute;
  top:calc(var(--rowH)/2);
  height:3px;
  background: var(--tc);
  border-radius:3px;
  z-index:3;
}
.date-tag{
  position:absolute;
  top:calc(var(--rowH)/2 - 24px);
  transform:translateX(-50%);
  background:#fff;
  color:#333;
  font-size:11px;
  padding:2px 6px;
  border:1px solid var(--tc);
  border-radius:8px;
  box-shadow:0 1px 2px rgba(0,0,0,0.05);
  z-index:4;
}

.today-line{position:absolute; top:0; bottom:0; width:2px; background:red; z-index:4;}

@media print{
  body{margin:0;}
  .controls,.toolbar,.legend{display:none !important;}
  .gantt{border:none;}
  .date-col{overflow:visible;}
  .timeline{transform:scale(0.88); transform-origin: top left;}
  @page{size:A4 landscape; margin:10mm;}
}
</style>
</head>
<body>

<h2>תרשים גאנט — גרסה 5</h2>
<p>כולל: קו מקווקו מהמשימה לנקודת הזמן, צבע לפי נושא, זום, שבועות וייצוא.</p>

<div class="toolbar">
  <button id="zoomOut">זום −</button>
  <button id="zoomIn">זום +</button>
  <button id="zoomReset">איפוס זום</button>
  <button id="exportPDF">ייצוא ל‑PDF</button>
  <button id="exportPNG">ייצוא ל‑PNG</button>
  <span id="zoomInfo" style="color:#666; margin-inline-start:8px">יום: <span id="pxInfo"></span>px</span>
</div>

<div class="controls">
  <strong>נושאים:</strong>
  <label class="chip active"><input type="checkbox" class="topic-check" data-topic='מר"ס – ממשק' checked><span style="display:inline-block;width:12px;height:12px;border:1px solid #333;border-radius:3px;background:#2ca02c"></span> מר"ס – ממשק</label>
  <label class="chip active"><input type="checkbox" class="topic-check" data-topic="מסירות" checked><span style="display:inline-block;width:12px;height:12px;border:1px solid #333;border-radius:3px;background:#9467bd"></span> מסירות</label>
  <label class="chip active"><input type="checkbox" class="topic-check" data-topic="Osprey-H Raven" checked><span style="display:inline-block;width:12px;height:12px;border:1px solid #333;border-radius:3px;background:#1f77b4"></span> Osprey-H Raven</label>
  <label class="chip active"><input type="checkbox" class="topic-check" data-topic='אבלואציה  והטמעות' checked><span style="display:inline-block;width:12px;height:12px;border:1px solid #333;border-radius:3px;background:#d62728"></span> אבלואציה  והטמעות</label>
  <label class="chip active"><input type="checkbox" class="topic-check" data-topic='אנטגרציית תחנת Heavy' checked><span style="display:inline-block;width:12px;height:12px;border:1px solid #333;border-radius:3px;background:#ff7f0e"></span> אנטגרציית תחנת Heavy</label>
  <label class="chip active"><input type="checkbox" class="topic-check" data-topic="שיפורי מערכת" checked><span style="display:inline-block;width:12px;height:12px;border:1px solid #333;border-radius:3px;background:#17becf"></span> שיפורי מערכת</label>
  <button id="btnAll">בחר הכל</button>
  <button id="btnClear">נקה הכל</button>
</div>

<div class="gantt" id="gantt">
  <svg class="link-layer" id="linkLayer"></svg>

  <div class="label-col">
    <div class="topic-block label-block" data-topic='מר"ס – ממשק'>
      <div class="rows">
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#2ca02c" title="#7 — שריון מערכת (+ ספייר)">#7 — שריון מערכת (+ ספייר)</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#2ca02c" title='#5 — ישור קו דרישות ב"מ – מול רכאן'>#5 — ישור קו דרישות ב"מ – מול רכאן</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#2ca02c" title="#6 — קביעת מועד , יעדים ברורים ומקום לביצוע אנטגרציה">#6 — קביעת מועד , יעדים ברורים ומקום לביצוע אנטגרציה</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#2ca02c" title="#8 — בדיקות מעבדה בנתניה">#8 — בדיקות מעבדה בנתניה</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#2ca02c" title="#9 — הכנות לוגסטיות וחיבור בשטח">#9 — הכנות לוגסטיות וחיבור בשטח</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#2ca02c" title="#10 — הפעלה מבצעית מוגבלת">#10 — הפעלה מבצעית מוגבלת</div></div>
      </div>
    </div>

    <div class="topic-block label-block" data-topic="מסירות">
      <div class="rows">
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#9467bd" title="#13 — מסירת מערכת 76  (7046)">#13 — מסירת מערכת 76  (7046)</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#9467bd" title="#14 — מסירת מערכת נוספת יבשה ECTS">#14 — מסירת מערכת נוספת יבשה ECTS</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#9467bd" title="#15 — מסירת מערכת EGT מר&quot;ס">#15 — מסירת מערכת EGT מר"ס</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#9467bd" title="#16 — מסירת מערכת Heavy 1 טקטי">#16 — מסירת מערכת Heavy 1 טקטי</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#9467bd" title="#19 — מסירת מערכת EGV1 – איוש">#19 — מסירת מערכת EGV1 – איוש</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#9467bd" title="#17 — מסירת מערכת Heavy 2 טקטי">#17 — מסירת מערכת Heavy 2 טקטי</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#9467bd" title="#18 — מסירת מערכת Heavy 3 נייח">#18 — מסירת מערכת Heavy 3 נייח</div></div>
      </div>
    </div>

    <div class="topic-block label-block" data-topic="Osprey-H Raven">
      <div class="rows">
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#1f77b4" title="#1 — הטסת פלטפורמה – בדיקות משך (מטע&quot;ד דמה )">#1 — הטסת פלטפורמה – בדיקות משך (מטע"ד דמה )</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#1f77b4" title="#2 — אפיון ותיקונים בתמיכת פלטפורמה חדשה (קבצי קונפיגורציה , התאמת התראות ופעילות מערכת)">#2 — אפיון ותיקונים בתמיכת פלטפורמה חדשה (קבצי קונפיגורציה , התאמת התראות ופעילות מערכת)</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#1f77b4" title="#3 — בדיקת ממשק  raven טיפול בפערי שליטה">#3 — בדיקת ממשק  raven טיפול בפערי שליטה</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#1f77b4" title="#4 — ישור קו פלטפורמה- GPS מטען , חשמל ..">#4 — ישור קו פלטפורמה- GPS מטען , חשמל ..</div></div>
      </div>
    </div>

    <div class="topic-block label-block" data-topic='אבלואציה  והטמעות'>
      <div class="rows">
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#d62728" title='#23 — הכשרת מפעילות מר"ס'>#23 — הכשרת מפעילות מר"ס</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#d62728" title="#22 — הכשרת EGV ל 8109 תע&quot;ש">#22 — הכשרת EGV ל 8109 תע"ש</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#d62728" title="#21 — הכשרת רחפן Heavy למשתמש קצה">#21 — הכשרת רחפן Heavy למשתמש קצה</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#d62728" title="#20 — אבלואציה רחפן Heavy">#20 — אבלואציה רחפן Heavy</div></div>
      </div>
    </div>

    <div class="topic-block label-block" data-topic='אנטגרציית תחנת Heavy'>
      <div class="rows">
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#ff7f0e" title="#11 — בדיקות תקינות , ממשקים">#11 — בדיקות תקינות , ממשקים</div></div>
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#ff7f0e" title="#12 — הפעלה ממושכת (תע&quot;ש)">#12 — הפעלה ממושכת (תע"ש)</div></div>
      </div>
    </div>

    <div class="topic-block label-block" data-topic="שיפורי מערכת">
      <div class="rows">
        <div class="row"><div class="row-bg"></div><div class="label" style="color:#17becf" title="#24 — עדכון גרסאות – נדרשת הזמנת פיתוח למימוש מסקנות אבלואציה מהשטח">#24 — עדכון גרסאות – נדרשת הזמנת פיתוח למימוש מסקנות אבלואציה מהשטח</div></div>
      </div>
    </div>
  </div>

  <div class="date-col">
    <div class="timeline" id="timeline">
      <div class="scale-wrap">
        <div class="month-band" id="monthBand"></div>
        <div class="week-band" id="weekBand"></div>
        <div class="day-scale" id="dayScale">
          <div class="grid" id="grid"></div>
        </div>
      </div>

      <div class="today-line" id="todayLine" title="היום"></div>

      <div class="topic-block date-block" data-topic='מר"ס – ממשק'>
        <div class="rows">
          <div class="row"><div class="connector" data-start="0"></div><div class="pin" data-start="0"></div><div class="date-tag" data-start="0">07.01</div></div>
          <div class="row"><div class="connector" data-start="1"></div><div class="pin" data-start="1"></div><div class="date-tag" data-start="1">08.01</div></div>
          <div class="row"><div class="connector" data-start="6"></div><div class="pin" data-start="6"></div><div class="date-tag" data-start="6">13.01</div></div>
          <div class="row"><div class="connector" data-start="13"></div><div class="pin" data-start="13"></div><div class="date-tag" data-start="13">20.01</div></div>
          <div class="row"><div class="connector" data-start="21"></div><div class="pin" data-start="21"></div><div class="date-tag" data-start="21">28.01</div></div>
          <div class="row">
            <div class="connector" data-start="26"></div><div class="pin" data-start="26"></div><div class="date-tag" data-start="26">02.02</div>
            <div class="range-line" data-start="26" data-end="36"></div>
            <div class="pin" data-end="36"></div><div class="date-tag" data-end="36">12.02</div>
          </div>
        </div>
      </div>

      <div class="topic-block date-block" data-topic="מסירות">
        <div class="rows">
          <div class="row"><div class="connector" data-start="1"></div><div class="pin" data-start="1"></div><div class="date-tag" data-start="1">08.01</div></div>
          <div class="row"><div class="connector" data-start="7"></div><div class="pin" data-start="7"></div><div class="date-tag" data-start="7">14.01</div></div>
          <div class="row"><div class="connector" data-start="26"></div><div class="pin" data-start="26"></div><div class="date-tag" data-start="26">02.02</div></div>
          <div class="row"><div class="connector" data-start="29"></div><div class="pin" data-start="29"></div><div class="date-tag" data-start="29">05.02</div></div>
          <div class="row"><div class="connector" data-start="36"></div><div class="pin" data-start="36"></div><div class="date-tag" data-start="36">12.02</div></div>
          <div class="row"><div class="connector" data-start="50"></div><div class="pin" data-start="50"></div><div class="date-tag" data-start="50">26.02</div></div>
          <div class="row"><div class="connector" data-start="57"></div><div class="pin" data-start="57"></div><div class="date-tag" data-start="57">05.03</div></div>
        </div>
      </div>

      <div class="topic-block date-block" data-topic="Osprey-H Raven">
        <div class="rows">
          <div class="row"><div class="connector" data-start="7"></div><div class="pin" data-start="7"></div><div class="date-tag" data-start="7">14.01</div></div>
          <div class="row"><div class="connector" data-start="15"></div><div class="pin" data-start="15"></div><div class="date-tag" data-start="15">22.01</div></div>
          <div class="row"><div class="connector" data-start="22"></div><div class="pin" data-start="22"></div><div class="date-tag" data-start="22">29.01</div></div>
          <div class="row"><div class="connector" data-start="22"></div><div class="pin" data-start="22"></div><div class="date-tag" data-start="22">29.01</div></div>
        </div>
      </div>

      <div class="topic-block date-block" data-topic='אבלואציה  והטמעות'>
        <div class="rows">
          <div class="row">
            <div class="connector" data-start="13"></div><div class="pin" data-start="13"></div><div class="date-tag" data-start="13">20.01</div>
            <div class="range-line" data-start="13" data-end="15"></div>
            <div class="pin" data-end="15"></div><div class="date-tag" data-end="15">22.01</div>
          </div>
          <div class="row">
            <div class="connector" data-start="21"></div><div class="pin" data-start="21"></div><div class="date-tag" data-start="21">28.01</div>
            <div class="range-line" data-start="21" data-end="22"></div>
            <div class="pin" data-end="22"></div><div class="date-tag" data-end="22">29.01</div>
          </div>
          <div class="row"><div class="connector" data-start="25"></div><div class="pin" data-start="25"></div><div class="date-tag" data-start="25">01.02</div></div>
          <div class="row">
            <div class="connector" data-start="29"></div><div class="pin" data-start="29"></div><div class="date-tag" data-start="29">05.02</div>
            <div class="range-line" data-start="29" data-end="50"></div>
            <div class="pin" data-end="50"></div><div class="date-tag" data-end="50">26.02</div>
          </div>
        </div>
      </div>

      <div class="topic-block date-block" data-topic='אנטגרציית תחנת Heavy'>
        <div class="rows">
          <div class="row"><div class="connector" data-start="21"></div><div class="pin" data-start="21"></div><div class="date-tag" data-start="21">28.01</div></div>
          <div class="row"><div class="connector" data-start="36"></div><div class="pin" data-start="36"></div><div class="date-tag" data-start="36">12.02</div></div>
        </div>
      </div>

      <div class="topic-block date-block" data-topic="שיפורי מערכת">
        <div class="rows">
          <div class="row"><div class="connector" data-start="114"></div><div class="pin" data-start="114"></div><div class="date-tag" data-start="114">01.05</div></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* === Data === */
var DATES = ["2026-01-07", "2026-01-08", "2026-01-09", "2026-01-10", "2026-01-11", "2026-01-12", "2026-01-13", "2026-01-14", "2026-01-15", "2026-01-16", "2026-01-17", "2026-01-18", "2026-01-19", "2026-01-20", "2026-01-21", "2026-01-22", "2026-01-23", "2026-01-24", "2026-01-25", "2026-01-26", "2026-01-27", "2026-01-28", "2026-01-29", "2026-01-30", "2026-01-31", "2026-02-01", "2026-02-02", "2026-02-03", "2026-02-04", "2026-02-05", "2026-02-06", "2026-02-07", "2026-02-08", "2026-02-09", "2026-02-10", "2026-02-11", "2026-02-12", "2026-02-13", "2026-02-14", "2026-02-15", "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19", "2026-02-20", "2026-02-21", "2026-02-22", "2026-02-23", "2026-02-24", "2026-02-25", "2026-02-26", "2026-02-27", "2026-02-28", "2026-03-01", "2026-03-02", "2026-03-03", "2026-03-04", "2026-03-05", "2026-03-06", "2026-03-07", "2026-03-08", "2026-03-09", "2026-03-10", "2026-03-11", "2026-03-12", "2026-03-13", "2026-03-14", "2026-03-15", "2026-03-16", "2026-03-17", "2026-03-18", "2026-03-19", "2026-03-20", "2026-03-21", "2026-03-22", "2026-03-23", "2026-03-24", "2026-03-25", "2026-03-26", "2026-03-27", "2026-03-28", "2026-03-29", "2026-03-30", "2026-03-31", "2026-04-01", "2026-04-02", "2026-04-03", "2026-04-04", "2026-04-05", "2026-04-06", "2026-04-07", "2026-04-08", "2026-04-09", "2026-04-10", "2026-04-11", "2026-04-12", "2026-04-13", "2026-04-14", "2026-04-15", "2026-04-16", "2026-04-17", "2026-04-18", "2026-04-19", "2026-04-20", "2026-04-21", "2026-04-22", "2026-04-23", "2026-04-24", "2026-04-25", "2026-04-26", "2026-04-27", "2026-04-28", "2026-04-29", "2026-04-30", "2026-05-01"];

var WEEKS = [{"week": 2, "start": 0, "end": 5}, {"week": 3, "start": 5, "end": 12}, {"week": 4, "start": 12, "end": 19}, {"week": 5, "start": 19, "end": 26}, {"week": 6, "start": 26, "end": 33}, {"week": 7, "start": 33, "end": 40}, {"week": 8, "start": 40, "end": 47}, {"week": 9, "start": 47, "end": 54}, {"week": 10, "start": 54, "end": 61}, {"week": 11, "start": 61, "end": 68}, {"week": 12, "start": 68, "end": 75}, {"week": 13, "start": 75, "end": 82}, {"week": 14, "start": 82, "end": 89}, {"week": 15, "start": 89, "end": 96}, {"week": 16, "start": 96, "end": 103}, {"week": 17, "start": 103, "end": 110}, {"week": 18, "start": 110, "end": 115}];

/* === State === */
var pxDay = 26;

/* === Helpers === */
function leftPx(dayIdx){ return dayIdx * pxDay; }

// In RTL layout the label column is on the right, so we draw the timeline from right-to-left.
function totalW(){ return leftPx(daysCount()); }
function cellLeft(i){ return totalW() - ((i+1) * pxDay); }
function centerX(i){ return cellLeft(i) + (pxDay/2); }
function daysCount(){ return DATES.length; }
function byId(id){ return document.getElementById(id); }

function setPxDay(val){
  pxDay = Math.max(16, Math.min(48, val));
  document.documentElement.style.setProperty('--pxDay', pxDay + 'px');
  byId('pxInfo').textContent = pxDay;
  renderScale();
  positionMarkers();
  drawLinks();
}

function renderScale(){
  var monthBand = byId('monthBand');
  var weekBand  = byId('weekBand');
  var dayScale  = byId('dayScale');
  var grid      = byId('grid');

  monthBand.innerHTML = '';
  weekBand.innerHTML  = '';
  grid.innerHTML      = '';

  // remove previous .day nodes
  var oldDays = dayScale.querySelectorAll('.day');
  for (var k=0; k<oldDays.length; k++) oldDays[k].parentNode.removeChild(oldDays[k]);

  var curM = null, segStart = 0;

  for (var i=0; i<DATES.length; i++){
    var dt = new Date(DATES[i]);
    var m = dt.toLocaleString('en-GB', { month: 'short', year:'numeric' });
    if(m !== curM){
      if(curM !== null){
        var segW = leftPx(i) - leftPx(segStart);
        var div = document.createElement('div');
        div.style.width = segW + 'px';
        div.style.textAlign = 'center';
        div.textContent = curM;
        monthBand.appendChild(div);
      }
      curM = m; segStart = i;
    }
  }
  var lastW = leftPx(daysCount()) - leftPx(segStart);
  var lastDiv = document.createElement('div');
  lastDiv.style.width = lastW + 'px';
  lastDiv.style.textAlign = 'center';
  lastDiv.textContent = curM;
  monthBand.appendChild(lastDiv);

  for (var w=0; w<WEEKS.length; w++){
    var segW2 = leftPx(WEEKS[w].end) - leftPx(WEEKS[w].start);
    var div2 = document.createElement('div');
    div2.className = 'week-cell';
    div2.style.width = segW2 + 'px';
    div2.textContent = 'Week ' + WEEKS[w].week;
    weekBand.appendChild(div2);
  }

  for (var j=0; j<daysCount(); j++){
    var g = document.createElement('div');
    g.style.left  = cellLeft(j) + 'px';
    g.style.width = pxDay + 'px';
    grid.appendChild(g);

    var d = document.createElement('div');
    d.className = 'day';
    d.style.left = cellLeft(j) + 'px';

    var s = document.createElement('span');
    s.className = 'txt';
    var dt2 = new Date(DATES[j]);
    var dd = String(dt2.getDate()).padStart(2,'0');
    var mm = String(dt2.getMonth()+1).padStart(2,'0');
    s.textContent = dd + '.' + mm;
    d.appendChild(s);
    dayScale.appendChild(d);
  }

  var todayLine = byId('todayLine');
  var today = new Date(); today.setHours(0,0,0,0);
  var min = new Date(DATES[0]); min.setHours(0,0,0,0);
  var idx = Math.round((today - min)/(1000*60*60*24));
  var left = centerX(Math.max(0, Math.min(daysCount()-1, idx)));
  todayLine.style.left = left + 'px';
}

function positionMarkers(){
  var boundaryX = totalW();

  var connectors = document.querySelectorAll('.connector');
  for(var i=0;i<connectors.length;i++){
    var el = connectors[i];
    var s = parseInt(el.getAttribute('data-start'), 10);
    var xs = centerX(s);
    var left = Math.min(xs, boundaryX);
    var w = Math.abs(boundaryX - xs);
    el.style.left = left + 'px';
    el.style.width = w + 'px';
  }

  var pinsStart = document.querySelectorAll('.pin[data-start]');
  for(var j=0;j<pinsStart.length;j++){
    var p = pinsStart[j];
    var s2 = parseInt(p.getAttribute('data-start'), 10);
    p.style.left = (centerX(s2) - 5) + 'px';
  }

  var tagsStart = document.querySelectorAll('.date-tag[data-start]');
  for(var k=0;k<tagsStart.length;k++){
    var t = tagsStart[k];
    var s3 = parseInt(t.getAttribute('data-start'), 10);
    t.style.left = centerX(s3) + 'px';
  }

  var ranges = document.querySelectorAll('.range-line');
  for(var r=0;r<ranges.length;r++){
    var rl = ranges[r];
    var s4 = parseInt(rl.getAttribute('data-start'), 10);
    var e4 = parseInt(rl.getAttribute('data-end'), 10);
    var xs2 = centerX(s4);
    var xe2 = centerX(e4);
    var left2 = Math.min(xs2, xe2);
    var w2 = Math.abs(xe2 - xs2);
    rl.style.left = left2 + 'px';
    rl.style.width = w2 + 'px';
  }

  var pinsEnd = document.querySelectorAll('.pin[data-end]');
  for(var pe=0;pe<pinsEnd.length;pe++){
    var p2 = pinsEnd[pe];
    var e2 = parseInt(p2.getAttribute('data-end'), 10);
    p2.style.left = (centerX(e2) - 5) + 'px';
  }

  var tagsEnd = document.querySelectorAll('.date-tag[data-end]');
  for(var te=0;te<tagsEnd.length;te++){
    var tg = tagsEnd[te];
    var e3 = parseInt(tg.getAttribute('data-end'), 10);
    tg.style.left = centerX(e3) + 'px';
  }

  var tl = byId('timeline');
  tl.style.minWidth = totalW() + 'px';
}


/* Draw dashed links from label column boundary to each start pin */
function drawLinks(){
  var gantt = byId('gantt');
  var svg = byId('linkLayer');
  var labelCol = document.querySelector('.label-col');
  if(!gantt || !svg || !labelCol) return;

  svg.innerHTML = '';

  var ganttRect = gantt.getBoundingClientRect();
  if(ganttRect.width < 10 || ganttRect.height < 10) return;

  svg.setAttribute('width', Math.round(ganttRect.width));
  svg.setAttribute('height', Math.round(ganttRect.height));
  svg.setAttribute('viewBox', '0 0 ' + Math.round(ganttRect.width) + ' ' + Math.round(ganttRect.height));

  var labelColRect = labelCol.getBoundingClientRect();

  var labelBlocks = document.querySelectorAll('.label-col .topic-block.label-block');
  for (var b=0; b<labelBlocks.length; b++){
    var lb = labelBlocks[b];
    var topic = lb.getAttribute('data-topic');

    // safe attribute selector (quotes inside topic are not used in your topics, but keep it safe)
    var safeTopic = (topic || '').replace(/"/g, '\\"');
    var selector = '.date-col .topic-block.date-block[data-topic="' + safeTopic + '"]';
    var db = document.querySelector(selector);
    if(!db) continue;

    if(getComputedStyle(lb).display === 'none' || getComputedStyle(db).display === 'none') continue;

    var tc = (getComputedStyle(lb).getPropertyValue('--tc') || '').trim() || '#333';

    var dateRows = db.querySelectorAll('.rows > .row');
    for (var r=0; r<dateRows.length; r++){
      var dr = dateRows[r];
      var pinEl = dr.querySelector('.pin[data-start]');
      if(!pinEl) continue;

      var r2 = pinEl.getBoundingClientRect();
      var y  = (r2.top + r2.height/2) - ganttRect.top;

      // from boundary between columns (right edge of label-col)
      var x1 = (labelColRect.right - ganttRect.left) - 6;
      var x2 = (r2.left + r2.width/2) - ganttRect.left;

      if(!isFinite(x1) || !isFinite(x2) || !isFinite(y)) continue;

      var line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x1.toFixed(1));
      line.setAttribute('y1', y.toFixed(1));
      line.setAttribute('x2', x2.toFixed(1));
      line.setAttribute('y2', y.toFixed(1));
      line.setAttribute('stroke', tc);
      line.setAttribute('stroke-width', '1');
      line.setAttribute('stroke-dasharray', '3 4');
      line.setAttribute('opacity', '0.35');
      svg.appendChild(line);
    }
  }
}

function applyFilter(){
  var selected = [];
  var cbs = document.querySelectorAll('.topic-check');
  for (var i=0;i<cbs.length;i++){
    if(cbs[i].checked) selected.push(cbs[i].getAttribute('data-topic'));
  }

  var blocks = document.querySelectorAll('.topic-block');
  for (var j=0;j<blocks.length;j++){
    var t = blocks[j].getAttribute('data-topic');
    blocks[j].style.display = (selected.indexOf(t) !== -1) ? 'block' : 'none';
  }

  var chips = document.querySelectorAll('.chip');
  for (var k=0;k<chips.length;k++){
    var cb = chips[k].querySelector('input');
    if(cb) chips[k].classList.toggle('active', cb.checked);
  }

  try{ localStorage.setItem('gantt_topics', JSON.stringify(selected)); }catch(e){}
  drawLinks();
}

function restoreSelection(){
  try{
    var raw = localStorage.getItem('gantt_topics');
    if(raw){
      var sel = JSON.parse(raw);
      var cbs = document.querySelectorAll('.topic-check');
      for (var i=0;i<cbs.length;i++){
        var t = cbs[i].getAttribute('data-topic');
        cbs[i].checked = sel.indexOf(t) !== -1;
      }
    }
  }catch(e){}
  applyFilter();
}

function exportPDF(){ window.print(); }

function exportPNG(){
  var target = byId('gantt');
  var w = target.scrollWidth;
  var h = target.scrollHeight;
  var svgNS = 'http://www.w3.org/2000/svg';
  var xhtmlNS = 'http://www.w3.org/1999/xhtml';

  var svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('xmlns', svgNS);
  svg.setAttribute('width', w);
  svg.setAttribute('height', h);

  var fo = document.createElementNS(svgNS, 'foreignObject');
  fo.setAttribute('width', w);
  fo.setAttribute('height', h);

  var div = document.createElementNS(xhtmlNS, 'div');
  div.setAttribute('xmlns', xhtmlNS);

  var clone = target.cloneNode(true);
  clone.style.margin = '0';
  clone.style.border = 'none';
  clone.style.width = w + 'px';

  div.appendChild(clone);
  fo.appendChild(div);
  svg.appendChild(fo);

  var xml = new XMLSerializer().serializeToString(svg);
  var img = new Image();

  img.onload = function(){
    var canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,w,h);
    ctx.drawImage(img,0,0);

    var a = document.createElement('a');
    a.download = 'gantt.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  };

  img.onerror = function(){
    alert('ייצוא PNG נכשל בדפדפן זה. נסה Chrome/Edge עדכניים או הדפס ל‑PDF.');
  };

  img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
}

/* === Wire UI === */
byId('zoomOut').addEventListener('click', function(){ setPxDay(pxDay-2); });
byId('zoomIn').addEventListener('click', function(){ setPxDay(pxDay+2); });
byId('zoomReset').addEventListener('click', function(){ setPxDay(26); });

byId('exportPDF').addEventListener('click', exportPDF);
byId('exportPNG').addEventListener('click', exportPNG);

byId('btnAll').addEventListener('click', function(){
  var cbs = document.querySelectorAll('.topic-check');
  for (var i=0;i<cbs.length;i++) cbs[i].checked = true;
  applyFilter();
});

byId('btnClear').addEventListener('click', function(){
  var cbs = document.querySelectorAll('.topic-check');
  for (var i=0;i<cbs.length;i++) cbs[i].checked = false;
  applyFilter();
});

document.addEventListener('change', function(e){
  var t = e.target;
  if(t && t.classList && t.classList.contains('topic-check')) applyFilter();
});

window.addEventListener('resize', drawLinks);

var dateCol = document.querySelector('.date-col');
if(dateCol){
  dateCol.addEventListener('scroll', function(){ drawLinks(); }, {passive:true});
}

/* === Init === */
document.addEventListener('DOMContentLoaded', function(){
  setPxDay(26);
  restoreSelection();
  renderScale();
  positionMarkers();
  drawLinks();
});
</script>

</body>
</html>
